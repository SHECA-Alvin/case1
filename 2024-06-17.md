## 事件报告



### 概括

SHECA 收到邮件提醒，告知我们有一张证书的主题属性顺序存在问题，我们立刻排查，对所有2023年9月15日后签发的证书进行检测，发现一共有8张证书都主题属性顺序错误。

### 影响

据BR 2.0.0 中7.1.4.2章节的规定，当CA证书主体字段中包含表中列出的属性时，必须按照表中的相对顺序对这些属性进行编码，并遵循属性的指定编码要求。此规定自2023年9月15日起生效。

2023年9月15日之后SHECA一共签发了8张存在错误的SSL 证书，其中有3张签发给客户且已吊销，其余5张为SHECA内部使用，且均已吊销，未产生较大范围的影响。

### 时间线

所有时间戳均为北京时间 (UTC+8)

- **2023-04-11 00:00** BR 2.0.0 发布
- **2023-06-13 14:23** SHECA开发部门收到合规部门通知，要求按照 BR 2.0.0 中 7.1.4.2章节的规定调整CA系统中SSL证书的主题属性顺序。
- **2023-08-12 21:47** SHECA的测试部门测试通过，主题属性顺序的调整上线生产环境。
- **2023-09-15 00:00** BR 2.0.0 中 7.1.4.2章节的规定的证书主题属性顺序规定生效
- **2024-06-14 03:24** 我们收到邮件提醒，提示此证书https://crt.sh/?id=10981773243 的主题属性顺序有存在错误
- **2024-06-14 09:10** 调查开始
- **2024-06-14 09:05** 确认此张证书的主题属性顺错误，不符合BR 2.0.0 中7.1.4.2章节的要求。
- **2024-06-14 09:10** 立刻检查CA系统的zlint版本是否进行升级，确认当前系统中的zlint是最新版本。
- **2024-06-04 10:00** 编写脚本使用zlint 检查所有2023-09-15 签发的证书，发现存在8张证书存在相同的问题且有三张存问题的证书未吊销。
- **2024-06-04 10:12** 通过排查发现仅EV证书主题顺序存在问题，立刻通知业务部门暂停签发EV SSL 证书。
- **2024-06-14 10:21** 立刻吊销这三张存在问题的证书。（发生事故后24小时内吊销）。
- **2024-06-14 10:30** 开始排查问题产生的原因，SHECA我们在2023年8月份的时候针对这个规定对CA系统对做了改造，立刻排查相关的记录文档。
- **2024-06-14 12:30** 开启Bugzilla 漏洞向ccadb初步说明情况。
- **2024-06-14 21:30** 确认问题的原因是由于新旧CA系统并行运行，流量入口灰度比例分别为旧CA系统：50%，新CA系统：50%，在进行主题属性顺序改造的过程中，旧的CA系统未按照BR的要求进行更改，而新的CA系统中更改是有效的。测试工程师在测试过程中用例脚本仅执行了一次，且请求被转发中到了新的CA系统中，导致测试工程师未能发现旧的CA系统改造并未生效，在附件中附上了SHECA CA系统网络图，方便参考。
- **2024-06-14 22:30** 立即修复旧CA系统的BUG，并进行了版本发布。
- **2024-06-14 23:00** 开始起草事件报告。
- **2024-06-15 10:00** 发送报告初稿给相关负责人检查报告的说明是否准确清晰。
- **2024-06-17 17:00** 发布完整的事件报告。

### 根本原因分析

背景介绍：由于我们的旧的CA系统已经运营了13年，目前无法满足业务需求，因此我们在2022年12月启动了新的CA系统开发工作。新的CA系统在2023年3月完成开发并开始试运营。我们对两套CA系统并行运行然后按照百分比进行流量分配，以确保新的CA系统平稳替代旧的CA系统，新系统的流量比例随时间推进逐步增加。

- **为什么部分证书的主题属性顺序存在问题？**

  这些证书的请求流量被分配到了旧的CA系统中，而旧的CA系统未对证书的主题属性顺序的调整存在BUG，未按照预期要求实现。

- **为什么会在旧的CA系统中签发证书？**

  在两套CA系统切换过程中，我们并行运行两套系统并按百分比分配流量，以保证新系统平稳替代旧系统。因此，有一部分流量（旧CA系统：50%，新CA系统：50%）仍进入旧的CA系统。

- **为什么测试人员没有发现旧系统改造存在问题？**

  测试人员在测试环境中进行测试时，测试用例脚本仅运行了一次且流量被分配到了新的CA系统，导致未能发现旧CA系统改造存在问题。

- **为什么SHECA的lint工具未检测出这个问题？**

  我们使用zlint作为检测工具，并按时更新版本。然而，对证书主题顺序检查的功能是在2024年3月发布的，这些错误证书都是在2024年3月之前签发的，因此zlint未能检测出这个问题。

- **为什么没能主动及早的发现这个问题？**

  SHECA缺乏在lint工具更新后对旧证书进行检查的策略。

  **补充问题：为什么2024年03月份之后的证书主题属性全部是正确的？**

  由于在2024 -03-01之后，SHECA的CA系统已全部切换到新的CA系统，所以这些证书的主题项的顺序都是正确的。

### 得到教训

#### 进展顺利

- 收到告警后，SHECA迅速做出响应。
- 合规部门在2023年6月就向CA系统开发部门提出了证书主题项顺序的整改需求，开发部门在2023年8月完成了相关整改。因此，当收到邮件后，我们立即意识到这是一个程序错误，迅速查询相关开发文档，并很快定位到问题原因。

#### 哪些地方不太顺利

- 所以在本次case中我们错误的暴漏了报告人的个人信息，对此我们感到抱歉，后续我们的报告会经过严格的审核后再发出，杜绝此类情况发生。
- 在新旧CA系统的迭代过程中，我们常常忽视了对旧CA系统兼容性的充分考虑， 由于新旧系统的更新迭代，我们已经遇到过类似的问题。本次问题的产生也是由于新旧系统的切换。因此，我们需要反思这个问题，分析问题出现的原因，并记录下来。在之后的升级迭代中，应充分考虑这些易发问题。
- 针对两套CA系统并行运行的情况，测试部门的测试用例脚本不应仅在运行一次即认为通过测试，而应至少执行五次以上，以确保流量分别进入两个系统。
- zlint对BR规则更新的支持存在延迟，这导致我们未能及时发现问题。我们应在zlint的基础上增加SHECA自己的lint工具，以支持zlint尚未支持的lint。
- 在 lint 工具更新之后，我们未对之前签发的证书进行重新检查，导致由于工具本身未支持新的 lint 规则而未能发现证书问题。
- SHECA的合规人员在每周的巡检流程中关注了这两个case（https://bugzilla.mozilla.org/show_bug.cgi?id=1883731 和 https://bugzilla.mozilla.org/show_bug.cgi?id=1883779）。 由于我们认为已经对其进行了调整，并且lint工具更新后没有给出任何告警，因此SHECA并未重点跟进这个问题。

#### 我们的幸运

- 签发证书数量较少，未对大量订户产生影响。

### 行动项目

| 行动项目                                                     | 种类      | 到期日     |
| ------------------------------------------------------------ | --------- | ---------- |
| 撤销所有受影响的证书。                                       | *Prevent* | 2024-06-14 |
| 修复旧CA系统签发 SSL证书主题属性顺序不对的问题。             | *Prevent* | 2024-06-14 |
| 要求测试部门重新制定测试规则，对有灰度的系统测试用例运行次数必须超过三次以上，且要求通过日志确认新旧系统全部测到。 | Prevent   | 2024-06-17 |
| lint工具更新后，CICD流水线将增加执行检测脚本的步骤，该脚本会对过去半年内的所有证书进行检测，以增加对旧证书的检测策略。 | *Detect*  | 2024-06-18 |
| 开发SHECA自有的lint工具，此工具以zlint作为基础扩展开发zlint不支持的lint规则。 | *Detect*  | 2024-06-24 |

### 附录

#### 受影响证书的详细信息

https://crt.sh/?id=11044872118

https://crt.sh/?id=11033992247

https://crt.sh/?id=11032757670

https://crt.sh/?id=11031824086

https://crt.sh/?id=11031824053

https://crt.sh/?id=10981773243

https://crt.sh/?id=10810579104

https://crt.sh/?id=10810577035
